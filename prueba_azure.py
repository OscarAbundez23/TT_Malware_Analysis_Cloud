import sys, os, subprocess, json, shutil, multiprocessing
from azure.identity import DefaultAzureCredential
from azure.storage.blob import BlobServiceClient, BlobClient

def crearArchivo(lista):
    count=1
    with open("Archivo_debug.txt",mode="w") as file_descriptor:
        file_descriptor.write("Este es un archivo debug\n")
        for elemento in lista:
            file_descriptor.write(str(count)+".- "+str(elemento)+".\n")
        file_descriptor.write("Fin del archivo\n")

def subirResultados(listaResultados):
    id_suscripcion = listaResultados[0]
    cad_conexion = listaResultados[1]
    url_cuenta = listaResultados[2]
    nombre_contenedor_resultados = listaResultados[4]
    nombre_resultado = listaResultados[8]
    credential = DefaultAzureCredential()
    blob_service_client = BlobServiceClient(account_url=url_cuenta,credential=credential).from_connection_string(cad_conexion)

    blob_client = blob_service_client.get_blob_client(container=nombre_contenedor_resultados, blob=nombre_resultado)
    with open("Archivo_debug.txt",mode="w") as data:
        blob_client.upload_blob(data)

def getVariablesEntorno():
    id_suscripcion = os.getenv("SUBSCRIPTION_ID")
    cad_conexion = os.getenv("CONNECT_STRING")
    url_cuenta= os.getenv("ACCOUNT_URL")
    nombre_contenedor_muestras = os.getenv("SAMPLES_CONTAINER_NAME")
    nombre_contenedor_plantillas = os.getenv("TEMPLATE_CONTAINER_NAME")
    nombre_contenedor_resultados = os.getenv("RESULT_CONTAINER_NAME")
    nombre_muestra = os.getenv("SAMPLE_NAME")
    nombre_plantilla = os.getenv("TEMPLATE_NAME")
    nombre_resultado = os.getenv("RESULT_NAME")
    os.environ["GHIDRA_INSTALL_DIR"] = os.getenv("GHIDRA_INSTALL_DIR")[:-1]

    uri_resultados = os.getenv("PATH_RESULTADO")
    
    return [id_suscripcion, cad_conexion, url_cuenta, nombre_contenedor_muestras, nombre_contenedor_resultados, nombre_muestra, nombre_plantilla, nombre_contenedor_plantillas, nombre_resultado]

if __name__ == "__main__":
    lista = getVariablesEntorno()
    archivo = crearArchivo(lista)
    subirResultados(lista)