ARG image=ubuntu:20.04

FROM ${image} as source-internet
FROM source-internet as builder

RUN apt-get update --quiet && DEBIAN_FRONTEND=noninteractive apt-get install -y tzdata software-properties-common

RUN add-apt-repository ppa:deadsnakes/ppa && apt-get update

    #g++-multilib=4:9.* \
    #gcc-multilib \
RUN DEBIAN_FRONTEND=noninteractive  apt-get install -y \
    file \
    binutils \
    cpp \
    libimage-exiftool-perl \
    build-essential \
    python2.7 \
    git \
    wget \
    curl nano \
    swig \
    flex \
    bison \
    g++ \
    make \
    bsdmainutils \
    ssdeep \
    yara \
    make \
    pkg-config \
    valgrind  \
    p7zip-full \
    upx-ucl \
    foremost \
    elfutils\
    htop \
    cmake \
    libc6-dbg \
    scalpel \
    unzip \
    tree \
    zip \
    libsqlite3-dev \
    zlib1g-dev \
    libncurses5-dev \
    libgdbm-dev \
    libbz2-dev \
    libssl-dev \
    libdb-dev tk-dev \
    graphviz \
    openjdk-17-jdk-headless \
    python \
    python3-pip \
    python3-virtualenv \
    python3-venv

##
# Download ghidra (used by scripts)
RUN wget https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_11.0.1_build/ghidra_11.0.1_PUBLIC_20240130.zip

WORKDIR /home

##
# Install radare2
#RUN python -m ensurepip --upgrade
RUN python3 -m venv .env --without-pip --system-site-packages

RUN git clone https://github.com/radareorg/radare2
RUN radare2/sys/install.sh

RUN r2pm -U
#RUN r2pm -i r2dec
RUN r2pm -ci r2ghidra
RUN r2pm -ci r2ghidra-sleigh

##
# Copy analysis source code
RUN mkdir /home/ubuntu

COPY ./script_venv.sh /home

RUN chmod +x /home/script_venv.sh
RUN /home/script_venv.sh

COPY ./main.py /home/ubuntu
COPY ./ghidra_handler_module.py /home/ubuntu
COPY ./radare2_module_handler.py /home/ubuntu
COPY ./entropy_calc.py /home/ubuntu

COPY ./script_motor.sh /home
RUN chmod +x /home/script_motor.sh
ENTRYPOINT ["/bin/bash","/home/script_motor.sh"]